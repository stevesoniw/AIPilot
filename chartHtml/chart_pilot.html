<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ko" xml:lang="ko">
<head>
    <title>Chart-Pilot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />
    <meta http-equiv="Cache-Control" content="no-cache" />

    <link href="/static/assets/css/jquery-ui.min.css" rel="stylesheet" type="text/css">
    <link href="/static/assets/css/newFont.css" rel="stylesheet" type="text/css">
    <link href="/static/assets/css/common.css" rel="stylesheet" type="text/css">
    <link href="/static/assets/css/chart-pilot.css" rel="stylesheet" type="text/css" />
    <!-- fullcalendar CDN -->  
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.css' rel='stylesheet' /> 
</head>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.js'></script>  
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/locales-all.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2"></script>
     
    <script type="text/javascript" src="/static/assets/js/jquery-3.6.4.min.js"></script>
    <script type="text/javascript" src="/static/assets/js/jquery-ui.min.js"></script>
    <script>
        var g_news;
        window.onload = function() {  //로딩바들 none 으로 일단 초기화하고 시작
            hideLoadingBars('loading_bar');
        };

        function hideLoadingBars(prefix) {
            var elements = document.querySelectorAll('[id^="' + prefix + '"]');
            elements.forEach(function(element) {
                element.style.display = 'none';
            });
        }
//************************************** FIN GPT 함수 Starts ********************************************//

        //FinGPT 최근 실적발표 History 및 애널리스트 추천 트렌드 차트보여주기
        async function loadChartData() {
            const ticker = document.getElementById('ticker').value;             
            try {
                document.getElementById('loading_bar_fingpt').style.top = '50%';                 
                document.getElementById('loading_bar_fingpt').style.display = 'block';                    
                document.getElementById('fingptChartArea').style.display = 'none';                
                document.getElementById('gpt-message-area').style.display = 'none';

                if (!ticker) {
                    alert('Please enter a ticker symbol.');
                    document.getElementById('loading_bar_fingpt').style.display = 'none';  
                    return;
                }
                const response = await fetch(`/api/charts/both/${ticker}`);
                const data = await response.json();

                // Base64 인코딩된 이미지 데이터를 이미지 태그의 src 속성에 할당
                document.getElementById('earningsChart').src = 'data:image/png;base64,' + data.earnings_chart;
                document.getElementById('recommendationsChart').src = 'data:image/png;base64,' + data.recommendations_chart;

                // 차트 영역을 보이게 설정
                document.getElementById('fingptChartArea').style.display = 'block';
                document.getElementById('loading_bar_fingpt').style.display = 'none';  
                gptAnalysis(ticker);

            } catch (error) {
                console.error('Error loading chart data:', error);
                gptAnalysis(ticker);
                document.getElementById('fingptChartArea').style.display = 'none';
                document.getElementById('loading_bar_fingpt').style.display = 'none'; 
            }
        }
        //FinGPT 실적발표 전후 반응 + 근거 문서 갖고와서 보여주기 
        async function gptAnalysis(ticker) {
            try {   
                //데이터 일단 클리어
                document.getElementById('analysisResult').innerHTML = "";    
                document.getElementById('newsAnalysis').innerHTML = "";                     
                document.getElementById('gpt-message-area').style.display = 'block';
                document.getElementById('loading_bar_fingpt').style.top = '130%';  
                document.getElementById('loading_bar_fingpt').style.display = 'block';  


                const response = await fetch(`/api/analysis/${ticker}`);
                const data = await response.json();
                if(data){
                    const formattedCompletion = data.completion.replace(/\n/g, '<br>');
                    const formattedPrompt = data.prompt_news.replace(/\n/g, '<br>');
                    document.getElementById('analysisResult').innerHTML = formattedCompletion;
                    document.getElementById('newsAnalysis').innerHTML = formattedPrompt;
                    document.getElementById('loading_bar_fingpt').style.display = 'none';   
                    gptStockWave(ticker)                      
                }

            }catch (error) {
                console.error('Error loading Stock Analysis:', error);
                document.getElementById('gpt-message-area').style.display = 'none';
                document.getElementById('loading_bar_fingpt').style.display = 'none'; 
            }                
        }
        //FinGPT 최근 1년 주가 흐름과 거래량 추이 보여주기 (이미지 호출)
        async function gptStockWave(ticker) {
            try {
                document.getElementById('loading_bar_fingpt').style.bottom = '10%';
                document.getElementById('loading_bar_fingpt').style.display = 'block';  
                document.getElementById('gpt-stockwave-area').style.display = 'none';                

                const response = await fetch(`/api/stockwave/${ticker}`);
                const data = await response.json();

                // Base64 인코딩된 이미지 데이터를 이미지 태그의 src 속성에 할당
                document.getElementById('stockwaveChart').src = 'data:image/png;base64,' + data.stockwave_data;
                // 주가흐름 영역을 보이게 설정
                document.getElementById('gpt-stockwave-area').style.display = 'block';   
                document.getElementById('loading_bar_fingpt').style.display = 'none';  

            } catch (error) {
                console.error('Error loading stockwave data:', error);
                document.getElementById('gpt-stockwave-area').style.display = 'none';                
                document.getElementById('loading_bar_fingpt').style.display = 'none'; 
            }         
        }

//************************************** FIN GPT 함수 Ends ********************************************// 
//******************************** 글로벌 주요경제지표 함수 [#1.핵심지표] Starts ***********************************// 

        /** 서버에서 이미지 만들어서 base64로 받아오는 형태 [차트가 안예뻐서 일단 보류]
        async function loadEconomicIndicators() {
            try {
                document.getElementById('loading_bar_economics').style.display = 'block';

                const response = await fetch('/api/economic-indicators');
                const data = await response.json();

                document.getElementById('economicChartArea').style.display = 'block';
                document.getElementById('economicIndicators').src = 'data:image/png;base64,' + data.economic_indicators_chart;
                document.getElementById('loading_bar_economics').style.display = 'none';

            } catch (error) {
                console.error('Error loading loadEconomicIndicators data:', error);
                document.getElementById('loading_bar_economics').style.display = 'none';                 
                document.getElementById('economicChartArea').style.display = 'none';             
            }     
        }**/

        async function fetchAndDisplayIndicators() {
            try {
                const form = document.getElementById('indicatorForm');
                const formData = new FormData(form);
                const selectedIndicators = formData.getAll('indicators');
                const aiOpinionCheck = document.getElementById('aiOpinionCheck').checked;
        
                document.getElementById('loading_bar_economics').style.display = 'block';
        
                const url = `/api/economic-indicators?indicators=${selectedIndicators.join(',')}&aiOpinion=${aiOpinionCheck}`;
                const response = await fetch(url);
                const data = await response.json();
                document.getElementById('loading_bar_economics').style.display = 'none';
        
                // 차트 및 분석 데이터의 표시 여부를 결정
                const chartContainer = document.getElementById('chartContainer');
                const chartAnalysisArea = document.getElementById('chart-anal-area');
                if (data && data.datasets.length > 0) {
                    chartContainer.style.display = 'block';
                    if(data.chart_talk){
                        chartAnalysisArea.style.display = 'block';
                        document.getElementById('chartAnalysis').innerText = data.chart_talk;
                    }else{
                        chartAnalysisArea.style.display = 'none';
                    }
                } else {
                    chartContainer.style.display = 'none';
                    chartAnalysisArea.style.display = 'none';
                }
        
                const backgroundColors = [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)'
                ];
                const borderColors = [
                    'rgba(255,99,132,1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ];
                const indicatorLabels = {
                    "CPIAUCSL": "소비자물가지수 (CPI)",
                    "PCEPI": "개인소비지출 (PCE)",
                    "PPIFID": "생산자물가지수 (PPI)",
                    "DFEDTARU": "연방기금금리",
                    "CSUSHPISA": "주택가격지수",
                    "A191RL1Q225SBEA": "실질 국내총생산 (GDP)"
                };
    
                // 데이터셋 설정
                const transformedDatasets = data.datasets.map((dataset, i) => ({
                    ...dataset,
                    data: dataset.data.map((value, index) => ({ t: data.labels[index], y: value })),
                    backgroundColor: backgroundColors[i % backgroundColors.length],
                    borderColor: borderColors[i % borderColors.length],
                    borderWidth: 3,
                    pointBackgroundColor: borderColors[i % borderColors.length],
                    pointBorderColor: "#fff",
                    pointHoverBackgroundColor: "#fff",
                    pointHoverBorderColor: borderColors[i % borderColors.length],
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    label: indicatorLabels[dataset.label] || dataset.label,
                    fill: false,
                    spanGaps: true,
                }));
                
        
                // 차트 생성
                const ctx = document.getElementById('myEconomicChart').getContext('2d');
                if (window.myEconomicChart instanceof Chart) {
                    window.myEconomicChart.destroy();
                }
                window.myEconomicChart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets: transformedDatasets },
                    options: {
                        responsive: true,
                        spanGaps: true,
                        title: { display: true, text: 'Economic Indicators Over Time' },
                        scales: {
                            xAxes: [{ type: 'time', time: { parser: 'YYYY-MM-DD', tooltipFormat: 'll', unit: 'day',
                                                                displayFormats: {
                                                                    day: 'MMM D, YYYY',
                                                                    month: 'MMM YYYY',
                                                                    year: 'YYYY'
                                                               }
                                                          },
                                      scaleLabel: { display: true, labelString: 'Date' },
                                      ticks: {
                                            autoSkip: true,
                                            maxTicksLimit: 20 // X축에 표시할 최대 눈금 수를 조정하여 레이블이 겹치지 않도록 함
                                      }
                                    }],
                            yAxes: [{ ticks: { beginAtZero: false }, scaleLabel: { display: true, labelString: 'Value' } }]
                        },
                        legend: { position: 'top' },
                        tooltips: { mode: 'index', intersect: false },
                        hover: { mode: 'nearest', intersect: true }
                    }
                });
            } catch (error) {
                console.error('Error loading economic indicators data:', error);
                document.getElementById('loading_bar_economics').style.display = 'none';
            }
        }
        
        function clearData() {
            // 모든 체크박스 선택 해제
            document.querySelectorAll('#indicatorForm input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        
            // 차트 데이터 클리어 (Chart.js 인스턴스가 있다면)
            if (window.myEconomicChart) {
                window.myEconomicChart.destroy(); // 차트 인스턴스를 파괴하여 클리어
            }
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('chart-anal-area').style.display = 'none';            
            document.getElementById('chartAnalysis').innerText = "";            
        }        
        
//****************************** 글로벌 주요경제지표 함수 [#1.핵심지표] Ends *******************************// 
//****************************** 글로벌 주요경제지표 함수 [#2.채권가격] Start ******************************// 

    async function fetchBondsData() {
        // 'bonds_chart_div'에 이미 차트 데이터가 있으면 요청 중단(=메뉴이동 시에 한번 호출한적 있으면 하지말자)
        const bondsChartDiv = document.getElementById('bonds_chart_div');
        if (Plotly.d3.select(bondsChartDiv).select('.plot-container').node()) {
            // 차트가 이미 그려져 있다면 함수 종료
            console.log('Chart already drawn. Skipping fetch.');
            return;
        }
        try {
            // 'loading_bar_bonds'을 표시
            document.getElementById('loading_bar_bonds').style.display = 'block';

            // 서버에서 차트 구성 데이터와 레이아웃 설정을 가져오기
            const response = await fetch('/get_bonds_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            
            // JSON으로 데이터 변환
            const data = await response.json();
            
            // 기준금리 차트 데이터 및 레이아웃 설정
            const baseRateData = data.base_rate_chart.data;
            const baseRateLayout = data.base_rate_chart.layout;

            // 이자율 차트 데이터 및 레이아웃 설정
            const interestRateData = data.interest_rate_chart.data;
            const interestRateLayout = data.interest_rate_chart.layout;
            
            // Plotly 차트를 생성
            Plotly.newPlot('bonds_chart_div', baseRateData, baseRateLayout);
            Plotly.newPlot('interest_chart_div', interestRateData, interestRateLayout);
            // 'loading_bar_bonds' 숨기기
            document.getElementById('loading_bar_bonds').style.display = 'none';
            var bondArea = document.getElementById('bond-area').style.display = 'block';
        }catch (error) {
            console.error('Error loading fetchBondsData(chart):', error);
            document.getElementById('loading_bar_bonds').style.display = 'none';
        }
        
    }

    //채권 뉴스 가져오기
    async function fetchAndDisplayBondsNews(category) {
        try{
            document.getElementById('loading_bar_bondsNews').style.display = 'block';
            const response = await fetch(`/bond-news/${category}`);
            const bondNews = await response.json();
        
            document.getElementById('loading_bar_bondsNews').style.display = 'none';

            console.log(bondNews);

            const bondsNewsContainer = document.getElementById('bonds_news_div');

            if (bondNews.length === 0) {
                // 뉴스 데이터가 없을 경우 표시할 메시지
                const noNewsMessage = document.createElement('div');
                noNewsMessage.textContent = '관련 뉴스가 없습니다.';
                noNewsMessage.className = 'no-news-message'; // 스타일 적용을 위한 클래스 추가
                bondsNewsContainer.appendChild(noNewsMessage);
            } else {

                bondsNewsContainer.innerHTML = ''; // 기존 내용을 지우고 새로운 뉴스로 업데이트
                bondNews.forEach(news => {
                    const newsDiv = document.createElement('div');
                    newsDiv.className = 'bondNews-container';

                    console.log(news.title)
                    const imageUrl = news.gettyImageUrl || "/static/assets/images/nature.jpg"; // 기본 이미지 경로 설정
                    const image = document.createElement('img');
                    image.src = imageUrl;
                    image.alt = "News Image";
                    image.className = 'bondNews-image';
            
                    const title = document.createElement('div');
                    title.className = 'bondNews-title';
                    title.textContent = news.title;
            
                    const content = document.createElement('div');
                    content.className = 'bondNews-content';
                    content.innerHTML = news.content; 

                    // '한국어로 번역하기' 버튼 추가
                    const translateButton = document.createElement('button');
                    translateButton.textContent = '한국어로 번역하기';
                    translateButton.className = 'translate-button'; // 스타일 적용을 위한 클래스 추가

                    translateButton.addEventListener('click', function() {
                        const newsItem = this.parentNode; // 뉴스 항목의 컨테이너 참조
                        const newsTitle = newsItem.querySelector('.bondNews-title').textContent;
                        const newsContent = newsItem.querySelector('.bondNews-content').innerHTML;
                    
                        // 로딩바 HTML 문자열
                        const loadingBarHtml = `
                            <div id="loading_bar_bondsTranslate" class="loading_bar_translate">
                                <img src="/static/assets/images/LoadingBar_A.gif">
                                <p class="loading-text">데이터 로딩중입니다.</p>
                            </div>`;
                    
                        // 로딩바를 뉴스 항목에 추가
                        newsItem.insertAdjacentHTML('beforeend', loadingBarHtml);
                        const loadingBar = newsItem.querySelector('.loading_bar_translate');
                        loadingBar.style.display = 'block'; // 로딩바 표시
                    
                        fetch('/translate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ title: newsTitle, content: newsContent })
                        })
                        .then(response => response.json())
                        .then(data => {
                            // 번역된 내용으로 업데이트
                            newsItem.querySelector('.bondNews-title').textContent = data.title;
                            newsItem.querySelector('.bondNews-content').innerHTML = data.content;
                            
                            // 로딩바 제거
                            loadingBar.style.display = 'none'; 
                            loadingBar.remove();
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            // 오류 발생 시 로딩바도 제거
                            loadingBar.style.display = 'none';
                            loadingBar.remove();
                        });
                    });
                
            
                    newsDiv.appendChild(image);
                    newsDiv.appendChild(translateButton);                     
                    newsDiv.appendChild(title);
                    newsDiv.appendChild(content);

                    bondsNewsContainer.appendChild(newsDiv);
                });
            }
        }catch (error) {
                console.error('Error loading fetchAndDisplayBondsNews[news]:', error);
                document.getElementById('loading_bar_bondsNews').style.display = 'none';
        }
    }
//****************************** 글로벌 주요경제지표 함수 [#2.채권가격] Ends ******************************// 
//************************************** 뉴스요청 함수 Starts ******************************************//
        async function goNews() {
            const checkboxes = document.querySelectorAll("#categoryForm input[name='categories']");
            const selectedCategories = Array.from(checkboxes)
                                         .filter(checkbox => checkbox.checked)
                                         .map(checkbox => checkbox.value);
        
            // 하나도 체크하지 않은 경우 알림을 표시하고 함수를 종료합니다.
            if (selectedCategories.length === 0) {
                alert("하나 이상의 카테고리를 선택하세요.");
                return;
            }

            document.getElementById('gpt_opinion').innerHTML = ""; 
            document.getElementById('gpt_summary').innerHTML = "";  
            document.getElementById('gpt-thoughts-container').style.display = 'none'; 
            document.getElementById('gpt-summary-container').style.display = 'none';             
            document.getElementById('loading_bar_news').style.display = 'block';    

            try {
                const newsContainer = document.getElementById('news');
                newsContainer.innerHTML = '';                
                const response = await fetch('/seekingNews', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({categories: selectedCategories})
                });
        
                g_news = await response.json();
                //g_news = newsResult
                const seekingNewsData = JSON.parse(g_news);
        
                if (seekingNewsData) {
                    // displayNews 함수를 호출하여 뉴스 데이터를 화면에 표시
                    document.getElementById('loading_bar_news').style.display = 'none';
                    displayNews(seekingNewsData);
                } else {
                    console.error('could not get the seekingNewsData');
                }
            } catch (error) {
                console.error('Error fetching news:', error);
            } finally {
                document.getElementById('loading_bar_news').style.display = 'none';
            }  
        }
        // 뉴스 데이터 갖고와서 HTML로 넣어주는 함수 
        function displayNews(seekingNewsData) {
            const newsContainer = document.getElementById('news');
            newsContainer.innerHTML = '';
            const defaultImageUrl = "/static/assets/images/nature.jpg";
            if (Array.isArray(seekingNewsData)) {
                seekingNewsData.forEach(item => {
                    const imageUrl = item.gettyImageUrl || defaultImageUrl;
                    const newsItem = document.createElement('div');
                    newsItem.className = 'news-item';
                    newsItem.innerHTML = `
                        <div class="news-content">
                            <img src="${imageUrl}" alt="News Image">
                            <div>
                                <div class="news-title">${item.title}</div>
                                <p class="news-body">${item.content}</p>
                                <div class="publish-date">Published on: ${item.publishOn}</div>
                            </div>
                        </div>
                    `;
                    const translateButton = document.createElement('button');
                    translateButton.className = 'newstrans-button';
                    translateButton.textContent = '한국어 번역하기';
                    newsItem.querySelector('.news-content > div').appendChild(translateButton); // 버튼을 뉴스 컨텐츠 div에 추가

                    translateButton.addEventListener('click', async function() {
                        const loadingBar = document.createElement('div');
                        loadingBar.className = 'loading-bar';
                        loadingBar.innerHTML = '<img src="/static/assets/images/LoadingBar_C.gif" alt="Loading" />';
                        newsItem.appendChild(loadingBar);

                        try {
                            const response = await fetch('/translate', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ title: item.title, content: item.content })
                            });
                            if (!response.ok) throw new Error('Network response was not ok.');
                            const translatedData = await response.json();

                            newsItem.querySelector('.news-title').textContent = translatedData.title;
                            newsItem.querySelector('.news-body').innerHTML = translatedData.content;
                        } catch (error) {
                            console.error('Error:', error);
                        } finally {
                            loadingBar.remove();
                        }
                    });

                    newsContainer.appendChild(newsItem);
                });
            } else {
                console.error('Received data is not an array:', seekingNewsData);
            }
        }


        async function gptRequest(action) {
            if (g_news.length === 0) {
                alert("뉴스데이터가 조회된 후 클릭해주세요");
                return;
            }
            document.getElementById('gpt_opinion').innerHTML = ""; 
            document.getElementById('gpt_summary').innerHTML = "";  
            document.getElementById('gpt-thoughts-container').style.display = 'none'; 
            document.getElementById('gpt-summary-container').style.display = 'none'; 

            //alert(JSON.stringify({action: action, g_news: g_news}));
            const requestOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({action: action, g_news: g_news})                
            };
        
            try {
                document.getElementById('loading_bar_gpt').style.display = 'block';                
                const response = await fetch('/gptRequest', requestOptions);
                const data = await response.json();
                console.log(data);
        
                if (action === 'translate') {
                    document.getElementById('loading_bar_gpt').style.display = 'none';                    
                    displayNews(JSON.parse(data.result)); 
                } else if (action === 'opinions') {
                    const formattedText = data.result.replace(/\n/g, '<br>');
                    document.getElementById('gpt_opinion').innerHTML = formattedText;                    
                    document.getElementById('gpt-thoughts-container').style.display = 'block'; 
                    document.getElementById('loading_bar_gpt').style.display = 'none';
                }else if (action === 'summarize') {
                    const formattedText = data.result.replace(/\n/g, '<br>');                    
                    document.getElementById('gpt_summary').innerHTML = formattedText; 
                    document.getElementById('gpt-summary-container').style.display = 'block'; 
                    document.getElementById('loading_bar_gpt').style.display = 'none';
                }
        
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
//************************************** 뉴스요청 함수 Ends ******************************************//        
//**************************************** 마켓PDF분석  Starts ******************************************//

function performOCR(canvas) {
    // Canvas에서 이미지 데이터를 Base64 인코딩된 문자열로 변환
    const imageDataUrl = canvas.toDataURL('image/png');
    // 서버로 전송할 데이터 구성
    const data = { image: imageDataUrl };
    document.getElementById('ocrResultArea').innerText = "";
    document.getElementById('loading_bar_ocr').style.display = 'block';   

    // Fetch API를 사용하여 서버로 POST 요청 보내기
    fetch('/perform_ocr', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
    })
    .then(response => response.json())
    .then(data => {
        console.log('OCR 결과:', data);
        // OCR 결과 처리 (예: 화면에 표시)
        document.getElementById('loading_bar_ocr').style.display = 'none';   
        document.getElementById('ocrResultArea').innerText = data.texts;
    })
    .catch(error => {
        console.error('OCR 처리 중 오류 발생:', error);
        document.getElementById('loading_bar_ocr').style.display = 'none';   
    });
}

function ocrGptTest(canvas) {
    // Canvas에서 이미지 데이터를 Base64 인코딩된 문자열로 변환
    const imageDataUrl = canvas.toDataURL('image/png');

    // 서버로 전송할 데이터 구성
    const data = { image: imageDataUrl };

    document.getElementById('ocrResultArea').innerText = "";
    document.getElementById('loading_bar_ocr').style.display = 'block';   
    // Fetch API를 사용하여 서버로 POST 요청 보내기
    fetch('/ocrGptTest', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
    })
    .then(response => response.json())
    .then(data => {
        console.log('OCR 결과:', data);
        // OCR 결과 처리 (예: 화면에 표시)
        document.getElementById('loading_bar_ocr').style.display = 'none';   
        document.getElementById('ocrResultArea').innerText = data.texts;
    })
    .catch(error => {
        console.error('OCR 처리 중 오류 발생:', error);
        document.getElementById('loading_bar_ocr').style.display = 'none';   
    });
}

function interestData(){
    alert("금리 설명하기- 준비중입니다.")
}

//**************************************** 마켓PDF분석 Ends** ******************************************//
//************************************** 증시캘린더 함수 Starts ******************************************//
async function goCalendar() {
            document.getElementById('loading_bar_calendar').style.display = 'block';    
            // AJAX 요청을 통해 서버로부터 데이터 가져오기
            const response = await fetch('/calendar', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
                // 필요한 경우 body 추가
            });
            const calendarData = await response.json(); // JSON 형태로 데이터 받기
            document.getElementById('loading_bar_calendar').style.display = 'none';    

            console.log(calendarData);

            // "start" 날짜가 "2024-01-01" 이후인 데이터만 필터링
            const filteredData = calendarData.filter(event => new Date(event.start) >= new Date("2024-01-01"));

            // FullCalendar 초기화 및 데이터 표시
            var calendarEl = document.getElementById('calendar');
            if (!calendarEl) {
                // 달력 컨테이너가 아직 페이지에 없는 경우
                alert('Calendar element not found on the page.');
                return;
            }
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title',  right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'},
                timeZone: 'UTC',
                expandRows: true, 
                locale : "KO",
                firstDay: 1,
                navLinks: true, 
                ihandleWindowResize : true,
                windowResizeDelay : 100,
                nowIndicator: true,
                dayMaxEvents: true, // 이벤트가 오버되면 높이 제한 (+ 몇 개식으로 표현)
                eventLimit: true, // 더 보기 버튼 활성화              
                events: filteredData.map(event => ({
                    id: event.id.toString(),
                    title: event.title,
                    start: event.start,
                    end: event.end,
                    color: `#${event.hexColor}`, // 이벤트 색상 설정
                    description: event.shortDesc // 이벤트 설명 추가
                })),

                eventContent: function(arg) { // 이벤트 내용 커스터마이징
                    var element = document.createElement('div');
                    element.innerHTML = `<b>${arg.event.title}</b><br>${arg.event.extendedProps.description}`;
                    return { domNodes: [element] };
                }
            });
            
            calendar.render();
        }
//************************************** 증시캘린더 함수 Ends ******************************************//
//******************************** 2nd GNB:: 국내 뉴스 Showing 영역 Starts *************************************//
// NAVER 뉴스 기본 정보 스크래핑해오기
function naverScrapingNews(newsType) {
    let url;
    var inputBox = document.querySelector('.naver-api-input');
    if (inputBox) {  //'내가검색하기' 쪽 인풋박스 일단 클리어 
        inputBox.value = '';  
    }
    document.querySelector('.news-api-btn').classList.remove('selected');
    switch (newsType) {
        case 1:
            url = "https://finance.naver.com/news/mainnews.naver";
            break;
        case 2:
            url = "https://finance.naver.com/news/news_list.naver?mode=LSS3D&section_id=101&section_id2=258&section_id3=401";
            break;
        case 3:
            url = "https://finance.naver.com/news/news_list.naver?mode=LSS3D&section_id=101&section_id2=258&section_id3=402";
            break;            
        case 4:
            url = "https://finance.naver.com/news/news_list.naver?mode=LSS3D&section_id=101&section_id2=258&section_id3=404";
            break;                        
        case 5:
            url = "https://finance.naver.com/news/news_list.naver?mode=LSS3D&section_id=101&section_id2=258&section_id3=406";
            break;            
        case 6:
            url = "https://finance.naver.com/news/news_list.naver?mode=LSS3D&section_id=101&section_id2=258&section_id3=429";
            break;            
        default:
            console.error('Invalid news type');
            return;
    }
    const apiUrl = `/naver-scraping-news?url=${encodeURIComponent(url)}`;
    fetch(apiUrl)
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        const newsShowArea = document.getElementById('news_show_area');
        newsShowArea.innerHTML = '';
        data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'naver-news-item';
            div.innerHTML = `
                <img src="${item.thumb_url ? item.thumb_url : '/static/assets/images/defaultNews.jpg'}" alt="" class="naver-news-thumb">
                <div class="naver-news-content">
                    <div class="naver-news-title">${item.article_subject}</div>
                    <div class="naver-news-summary">${item.summary}</div>
                    <div class="naver-news-info">${item.press} | ${item.wdate}</div>
                </div>
            `;
            const button = document.createElement('button');
            button.className = 'naver-news-detail-btn';
            button.textContent = '자세히 보기';
            button.addEventListener('click', function(event) {
                fetchDetaildNews(item.article_link, event);
            });
            div.appendChild(button);
            newsShowArea.appendChild(div);
        });
    })
    .catch(error => {
        console.error('Error fetching news:', error);
        document.getElementById('news_show_area').innerHTML = '<p>뉴스를 가져오는 중 오류가 발생했습니다.</p>';
    });
}
// NAVER 뉴스 상세 컨텐츠 스크래핑 해오기
function fetchDetaildNews(url, event) {
    fetch('/api/news-detail', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ url: url })
    })
    .then(response => response.text())
    .then(html => {
        const detailedNewsDiv = document.createElement('div');
        detailedNewsDiv.className = 'naver-news-detailed';
        detailedNewsDiv.innerHTML = html;
        event.target.closest('.naver-news-item').insertAdjacentElement('afterend', detailedNewsDiv);
    })
    .catch(error => {
        console.error('Error fetching detailed news:', error);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'naver-news-detailed';
        errorDiv.innerHTML = '<p>자세한 뉴스를 가져오는 중 오류가 발생했습니다.</p>';
        event.target.closest('.naver-news-item').insertAdjacentElement('afterend', errorDiv);
    });
}
// 네이버 키워드 입력란 보이게 하는 함수
function naverKeyword() {
    // 'naver-api-search-area' 요소가 이미 있는지 확인
    let searchArea = document.getElementById('naver-api-search-area');
    
    // 요소가 존재하지 않는 경우에만 생성 및 추가
    if (!searchArea) {
        searchArea = document.createElement('div');
        searchArea.setAttribute('id', 'naver-api-search-area');
        searchArea.innerHTML = `
        <span>검색할 뉴스 키워드를 입력해주세요 :</span>
        <input type="text" class="naver-api-input" placeholder="키워드 입력(예: 삼성전자)..." onfocus="this.value=''">
        <button class="naver-api-search-btn" onclick="naverSearchAPI()">검색</button>`;
        
        const newsSelectionArea = document.getElementById('news_selection_area');
        // 'news_selection_area'의 바로 다음에 검색 영역을 삽입
        document.getElementById('menu_2nd_a').insertBefore(searchArea, newsSelectionArea.nextSibling);
    }

    // naver-api-input에 자동으로 focus 설정 및 엔터키 이벤트 핸들러 설정
    const input = document.querySelector('.naver-api-input');
    if (input) {
        input.focus();
        input.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                naverSearchAPI();
            }
        });
    }
}

// 네이버 검색 API를 활용해서 뉴스까지 가져오자 
async function naverSearchAPI() {
    // 일단 다른 뉴스 버튼들 (news-btn)의 'selected' 클래스 제거
    document.querySelectorAll('.news-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    // news-api-btn에 'selected' 클래스 추가
    document.querySelector('.news-api-btn').classList.add('selected');  

    const keywordInput = document.querySelector('.naver-api-input');
    if (!keywordInput) return; // Exit if no input field found
    const keyword = keywordInput.value;
    // Update the apiUrl if necessary to match your FastAPI route
    const apiUrl = `/api/search-naver?keyword=${encodeURIComponent(keyword)}`;

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error('Network response was not ok');
        const { items } = await response.json(); // Destructure to get the items array

        const newsShowArea = document.getElementById('news_show_area');
        newsShowArea.innerHTML = ''; // Clear existing content

        items.forEach(item => {
            // Remove HTML tags from the title and description
            const title = item.title.replace(/<\/?[^>]+(>|$)/g, "");
            const description = item.description.replace(/<\/?[^>]+(>|$)/g, "");

            const div = document.createElement('div');
            div.className = 'naver-news-item';
            div.innerHTML = `
                <div class="naver-news-content">
                    <div class="naver-news-title">${title}</div>
                    <div class="naver-news-summary">${description}</div>
                    <div class="naver-news-info">${item.bloggername} | ${new Date(item.postdate).toLocaleDateString()}</div>
                </div>
                <a href="${item.link}" target="_blank" class="naver-news-detail-btn">자세히 보기</a>
            `;
            newsShowArea.appendChild(div);
        });
    } catch (error) {
        console.error('Error fetching news:', error);
        document.getElementById('news_show_area').innerHTML = '<p>뉴스를 가져오는 중 오류가 발생했습니다.</p>';
    }
}


//******************************** 2nd GNB:: 국내 뉴스 Showing 영역 Ends *************************************//
//******************************** 2nd GNB:: 국내 주식 유사국면 분석 Starts*************************************//

function similarSitu(){
    //alert("준비중입니다");
}

    </script>          
<body>
    <form id="rateForm" action="/submit" method="post" style="display:none;">
    </form>
    <div class="wrap" id="chartPilot">
        <!-- header 시작 -->
        <header class="myHeader">
            <h1 class="title-wrap">
                <a href="#" onClick="window.location.reload()"><img src="/static/assets/images/logo.png" alt="AI솔루션본부 PILOT" /></a>
            </h1>
            <nav class="menux">
                <ul>
                    <li data-menu="menu1"><a href="#">[해외]마켓데이터 분석</a></li>
                    <li data-menu="menu2"><a href="#">[국내]마켓데이터 분석</a></li>
                    <li data-menu="menu3"><a href="#">리서치 리포트 분석</a></li>
                </ul>
            </nav>
        </header>
        <mainx class="clear">
             <!-- left-nav 메뉴 시작 -->
            <div class="left-area">
                <div class="title-wrap">
                    <span>AI</span> Science팀 <span>Pilot</span>
                </div>
                <div class="menu-wrap">
                    <ul class="menu-list">
                        <li class="page-menu on" data-tab="menua"><a href="javascript:void(0);">1. AI가 말해주는 주식 정보 [해외]</a></li>
                        <li class="page-menu" data-tab="menub"><a href="javascript:void(0);">2. 글로벌 주요경제지표</a></li>
                        <li class="page-menu" data-tab="menuc"><a href="javascript:void(0);">3. 뉴스 데이터 분석 [해외] </a></li>
                        <li class="page-menu" data-tab="menud"><a href="javascript:void(0);">4. 마켓 PDF 분석</a></li>
                        <li class="page-menu" data-tab="menue"><a href="javascript:void(0);">5. 증시 캘린더</a></li>
                    </ul>
                </div>

            </div>
            <!-- left-nav 끝 -->

            <!-- 우측 영역 시작 -->
            <div class="right-area">
                <div id="menua" class="menu-cont on">
                    <h2 class="s-tit">AI가 말해주는 주식 정보 [해외]</h2>
                    <h3 class="s-tit">종목코드를 입력해주세요 (*예: AAPL) </h3>
                    <div class="input-container">
                        <input type="text" id="ticker" placeholder="(예 : AAPL) " class="input-ticker">
                        <div class="buttons-container">
                            <button class="chartBtn" id="getStockInfo" onclick="loadChartData();">Get Stock Info</button>
                        </div>
                    </div>
                    <div id="loading_bar_fingpt" class="loading_bar" style="margin-left: 0px;">
                        <img src="/static/assets/images/LoadingBar_C.gif">
                        <p>데이터 로딩중입니다.</p>
                    </div>                      
                    <div class="gpt-chart-area" id="fingptChartArea" style="display: none;">
                        <div>
                            <img id="earningsChart" alt="Earnings Chart">
                            <img id="recommendationsChart" alt="Recommendations Chart">
                        </div>
                    </div>
                    <div class="gpt-message-area" id="gpt-message-area" style="display: none;">
                        <div id="analysisResultBox" class="result-box">
                           <p class="info-header" id="message1">최근 실적발표가 있었던 경우에는, <span class="highlight">실적발표 전/후 반응</span>을 나누어 비교 분석합니다. 실적 발표 예정인 경우에는 이전 정보 기준으로만 분석합니다.</p>
                           <div id="analysisResult"></div>
                        </div>
                        <div id="newsAnalysisBox" class="result-box">
                            <p class="info-header">AI분석의 <span class="highlight">[근거가 되는 정보]</span>는 아래와 같습니다. (<span class="highlight">최신 영문 기사</span> 기반으로 수행되었습니다.)</p>
                            <div id="newsAnalysis"></div>
                        </div>
                    </div>

                    <div class="box-instruction" id="gpt-stockwave-area" style="display:none;">
                        <div>
                            <p class="info-header"> <span class="highlight">최근 1년 주가 흐름과 거래량 추이</span>를 참조하세요.</p>
                            <img id="stockwaveChart" alt="1년 주가 흐름과 거래량">
                        </div>  
                    </div>
                </div>                
                <div id="menub" class="menu-cont">
                    <h2 class="s-tit">글로벌 주요 경제지표</h2>
                    <h3 class="s-tit">1> 핵심지표 분석</h3>
                    <div class="form-container">
                        <p class="form-header">분석을 원하는 지표들을 선택해주세요.</p>
                        <form id="indicatorForm">
                            <div class="checkbox-row">
                                <div class="checkbox-group">
                                    <input type="checkbox" name="indicators" value="CPIAUCSL" id="CPIAUCSL">
                                    <label for="CPIAUCSL">소비자물가지수 (CPI)</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" name="indicators" value="PCEPI" id="PCEPI">
                                    <label for="PCEPI">개인소비지출 (PCE)</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" name="indicators" value="PPIFID" id="PPIFID">
                                    <label for="PPIFID">생산자물가지수 (PPI)</label>
                                </div>
                            </div>
                            <div class="checkbox-row">
                                <div class="checkbox-group">
                                    <input type="checkbox" name="indicators" value="DFEDTARU" id="DFEDTARU">
                                    <label for="DFEDTARU">연방기금금리</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" name="indicators" value="CSUSHPISA" id="CSUSHPISA">
                                    <label for="CSUSHPISA">주택가격지수</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" name="indicators" value="A191RL1Q225SBEA" id="A191RL1Q225SBEA">
                                    <label for="A191RL1Q225SBEA">실질 국내총생산(GDP)</label>
                                </div>
                            </div>
                            <div class="form-actions">
                                <div class="ai-opinion-checkbox">
                                    <input type="checkbox" id="aiOpinionCheck" name="aiOpinionCheck">
                                    <label for="aiOpinionCheck" class="ai-opinion-label">AI의견 함께보기</label>
                                </div>
                                <div class="center-button">
                                    <button type="button" id="indicatorButton" class="indicatorButton" onclick="fetchAndDisplayIndicators();">Show Chart</button>
                                </div>                        
                                <button type="button" id="clearButton" onclick="clearData();">데이터 클리어</button>
                            </div> 
                            <div class="ai-opinion-warning">
                                *AI의견 함께보기 체크시 응답 속도가 늦어질수 있습니다.
                            </div>                                                      
                        </form>
                    </div>

                    <div id="loading_bar_economics" class="loading_bar" style="display: none;">
                        <img src="/static/assets/images/LoadingBar_A.gif">
                        <p>데이터 로딩중입니다.</p>
                    </div>                   
                    <div id="chartContainer" style="display: none;">
                        <canvas id="myEconomicChart" width="1200" height="600"></canvas>
                    </div>
                    <!--<div class="economic-chart-area" id="economicChartArea" style="display:none;">
                        <div>
                            <img id="economicIndicators" alt="Economic Indicators Chart">
                        </div>
                    </div>-->                  
                    <div class="box-instruction" id="chart-anal-area" style="display: none;">
                        <p class="chart-analysis-title">차트 데이터 분석</p> 
                        <ul class="list-dep">
                            <div id="chartAnalysis"></div>
                        </ul>
                    </div>
                    <h3 class="nth-menu">2> 미국 채권 데이터 분석</h3>
                    <div class="bond-chart-area">
                        <div id="loading_bar_bonds" class="loading_bar" style="margin-left: 0px;">
                            <img src="/static/assets/images/LoadingBar_C.gif">
                            <p>데이터 로딩중입니다.</p>
                        </div>   
                        <div id="bonds_chart_div"></div>           
                        <div id="interest_chart_div"></div>  
                    </div>
                    <div class="bond-area" id="bond-area" style="display:none;">
                        <div class="center-button">
                            <button type="button" id="bondNewsButton" class="indicatorButton" onclick="fetchAndDisplayBondsNews('market-news::financials|market-news::issuance|market-news::us-economy');">채권관련 최근뉴스 보기</button>
                        </div>
                        <div id="loading_bar_bondsNews" class="loading_bar" style="margin-left: 0px;">
                            <img src="/static/assets/images/LoadingBar_A.gif">
                            <p class="loading-text">데이터 로딩중입니다.</p>
                        </div>                                                   
                        <div class="bondNews-instruction">
                            <ul class="news-dep">
                                <div id="bonds_news_div"></div>  
                            </ul>
                        </div>   
                    </div>                                     

                </div>


                <div id="menuc" class="menu-cont">
                    <h2 class="s-tit">뉴스 카테고리</h2>
                    <h3 class="s-tit">주요 시장뉴스를 확인해보세요!</h3>
                    <div class="category-selection">
                        <h3>Choose News Categories</h3>
                        <form id="categoryForm" class="category-form">
                            <!-- Example of a category -->
                            <div class="category" title="주식 시장 전반에 걸친 모든 소식이 여기에 속합니다.">
                                <input type="checkbox" id="all" name="categories" value="market-news::all" checked>
                                <label for="all">All Market News</label>
                            </div>  
                            <div class="category" title="시장에서 가장 중요하거나 영향력 있는 상위 뉴스를 다룹니다.">
                                <input type="checkbox" id="top-news" name="categories" value="market-news::top-news">
                                <label for="top-news">주요 Top News</label>
                            </div>
                            <div class="category" title="주목할 만한 주가 변동이나 시장 움직임에 관한 뉴스입니다.">
                                <input type="checkbox" id="on-the-move" name="categories" value="market-news::on-the-move">
                                <label for="on-the-move">주가변동</label>
                            </div>
                            <div class="category" title="시장의 전반적인 분위기나 트렌드를 반영하는 뉴스입니다.">
                                <input type="checkbox" id="market-pulse" name="categories" value="market-news::market-pulse">
                                <label for="market-pulse">시장 전반</label>
                            </div>
                            <div class="category" title="애널리스트들의 주목할 만한 의견이나 평가에 관한 뉴스입니다.">
                                <input type="checkbox" id="notable-calls" name="categories" value="market-news::notable-calls">
                                <label for="notable-calls">Notable Calls</label>
                            </div>
                            <div class="category" title="기업의 자사주 매입에 관한 뉴스입니다.">
                                <input type="checkbox" id="buybacks" name="categories" value="market-news::buybacks">
                                <label for="buybacks">자사주 매입</label>
                            </div>
                            <div class="category" title="원자재 시장에 관한 뉴스입니다. 금, 석유와 같은 상품의 가격 변동이나 시장 동향을 다룹니다.">
                                <input type="checkbox" id="commodities" name="categories" value="market-news::commodities">
                                <label for="commodities">Commodities</label>
                            </div>
                            <div class="category" title="새로운 주식 발행이나 채권 발행에 관한 뉴스입니다.">
                                <input type="checkbox" id="issuance" name="categories" value="market-news::issuance">
                                <label for="issuance">주식/채권 발행</label>
                            </div>
                            <div class="category" title="배당금을 지급하는 주식에 관한 뉴스입니다.">
                                <input type="checkbox" id="dividend-stocks" name="categories" value="market-news::dividend-stocks">
                                <label for="dividend-stocks">배당금 주식뉴스</label>
                            </div>
                            <div class="category" title="기업의 실적 발표에 관한 뉴스입니다.">
                                <input type="checkbox" id="earnings" name="categories" value="market-news::earnings">
                                <label for="earnings">기업 실적발표</label>
                            </div>
                            <div class="category" title="전 세계 시장에 관한 뉴스입니다.">
                                <input type="checkbox" id="global" name="categories" value="market-news::global">
                                <label for="global">세계시장 뉴스</label>
                            </div>
                            <div class="category" title="기업이 제공하는 장래 실적 예측에 관한 뉴스입니다.">
                                <input type="checkbox" id="guidance" name="categories" value="market-news::guidance">
                                <label for="guidance">장래실적예측</label>
                            </div>
                            <div class="category" title="새로운 기업의 주식시장 상장(IPO)에 관한 뉴스입니다.">
                                <input type="checkbox" id="ipos" name="categories" value="market-news::ipos">
                                <label for="ipos">IPO 뉴스</label>
                            </div>
                            <div class="category" title="정치적 이슈가 시장에 미치는 영향에 관한 뉴스입니다.">
                                <input type="checkbox" id="politics" name="categories" value="market-news::politics">
                                <label for="politics">정치적 뉴스</label>
                            </div>
                            <div class="category" title="인수합병(M&A)에 관한 뉴스입니다.">
                                <input type="checkbox" id="m-a" name="categories" value="market-news::m-a">
                                <label for="m-a">M&A</label>
                            </div>
                            <div class="category" title="미국 경제에 관한 뉴스입니다.">
                                <input type="checkbox" id="us-economy" name="categories" value="market-news::us-economy">
                                <label for="us-economy">US Economy</label>
                            </div>
                            <div class="category" title="소비자 시장과 관련된 뉴스입니다.">
                                <input type="checkbox" id="consumer" name="categories" value="market-news::consumer">
                                <label for="consumer">소비자 시장</label>
                            </div>
                            <div class="category" title="에너지 시장에 관한 뉴스입니다.">
                                <input type="checkbox" id="energy" name="categories" value="market-news::energy">
                                <label for="energy">에너지 시장</label>
                            </div>
                            <div class="category" title="금융 시장에 관한 뉴스입니다.">
                                <input type="checkbox" id="financials" name="categories" value="market-news::financials">
                                <label for="financials">금융 전반</label>
                            </div>
                            <div class="category" title="건강 관리 및 의료 산업에 관한 뉴스입니다.">
                                <input type="checkbox" id="healthcare" name="categories" value="market-news::healthcare">
                                <label for="healthcare">Healthcare</label>
                            </div>
                            <div class="category" title="MLP는 주로 에너지 인프라 분야에서 활동하는 투자 구조입니다.">
                                <input type="checkbox" id="mlps" name="categories" value="market-news::mlps">
                                <label for="mlps">에너지 인프라</label>
                            </div>
                            <div class="category" title="REIT는 부동산에 직접 투자하는 회사입니다.">
                                <input type="checkbox" id="reits" name="categories" value="market-news::reits">
                                <label for="reits">REITs</label>
                            </div>
                            <div class="category" title="기술 산업에 관한 뉴스입니다.">
                                <input type="checkbox" id="technology" name="categories" value="market-news::technology">
                                <label for="technology">Technology</label>
                            </div>
                            <div class="category" title="특수목적인수회사(SPAC)와 관련된 뉴스입니다.">
                                <input type="checkbox" id="spacs" name="categories" value="market-news::spacs">
                                <label for="spacs">SPACs</label>
                            </div>     
                        </form>
                        <div class="form-action">
                            <button type="button" class="load-news-btn" onclick="javascript:goNews()">News Call</button>
                        </div>                            
                    </div>
                     <div class="buttons-container">
                        <!--<button class="btn" onclick="javascript:gptRequest('translate')">한국어로 번역하기</button>-->
                        <button class="btn" onclick="javascript:gptRequest('opinions')">AI 의견보기</button>
                        <button class="btn" onclick="javascript:gptRequest('summarize')">내용 요약하기</button>
                    </div>
                    <div id="gpt-thoughts-container" style="display:none;">
                        <h3 class="gpt_t">GPT Thoughts</h3>
                        <div class="ai-box">
                            <ul class="list-dep">
                                <li><div id="gpt_opinion"></div></li>
                            </ul>
                        </div>
                    </div>
                    <div id="loading_bar_gpt" class="loading_bar" style="margin-left: 0px;">
                        <img src="/static/assets/images/LoadingBar_B.gif">
                        <p class="loading-text">데이터 로딩중입니다.</p>
                    </div>                    
                    <div id="gpt-summary-container" style="display:none;">
                        <h3 class="gpt_t">GPT Summary</h3>     
                        <div class="ai-box">
                            <ul class="list-dep">
                                <li><div id="gpt_summary"></div></li>
                            </ul>
                        </div>
                    </div>                       
                    <div id="loading_bar_gpt" class="loading_bar" style="margin-left: 0px;">
                        <img src="/static/assets/images/LoadingBar_B.gif">
                        <p style="color: red;">데이터 로딩중입니다.</p>
                    </div>                      
                    <div id="news">
                    </div>
                    <div id="loading_bar_news" class="loading_bar" style="margin-left: 0px;">
                        <img src="/static/assets/images/LoadingBar_C.gif">
                        <p style="color: red;">데이터 로딩중입니다.</p>
                    </div>                       
                </div>

                <div id="menud" class="menu-cont">
                    <h2 class="s-tit">마켓 PDF 분석</h2>
                    <h3 class="s-tit">Market Data Weekly 분석화면</h3>
                    <div class="upload-container">
                        <h2>Upload your PDF</h2>
                        <input type="file" id="fileInput" accept=".pdf" hidden/>
                        <label for="fileInput" class="file-label">Choose a file</label>
                        <span id="fileName" class="file-name">[No file chosen yet]</span>
                        <canvas id="pdfCanvas" hidden></canvas>
                    </div>
                    <div id="ocrArea"></div>
                    <div id="buttonsContainer" style="text-align: center;"></div> 
                    <div id="loading_bar_ocr" class="loading_bar_translate">
                        <img src="/static/assets/images/LoadingBar_C.gif">
                        <p class="loading-text">데이터 로딩중입니다.</p>
                    </div>
                    <div class="box-instruction">
                        <ul class="list-dep">
                            <div id="ocrResultArea"></div>
                        </ul>
                    </div>
                </div>

                <div id="menue" class="menu-cont">
                    <h2 class="s-tit">증시 캘린더</h2>
                    <h3 class="s-tit">Official Source등을 통해서 생성한 economic calendar 입니다.</h3>

                    <div id="loading_bar_calendar" class="loading_bar" style="margin-left: 0px;">
                        <img src="/static/assets/images/LoadingBar_C.gif">
                        <p>데이터 로딩중입니다.</p>
                    </div>     
                    <div id="calendar"></div>                        
                </div>     
<!--------------------------------       [[ GNB 2ND ]]   --------------------------------------------->
                <!------------ [국내] 마켓데이터 분석 -------------->
                <div id="menu_2nd_a" class="menu-cont">
                    <h2 class="s-tit">국내 뉴스 Summary</h2>
                    <h3 class="s-tit">주요 시장 뉴스를 확인해보세요</h3>
 
   
                    <div id="news_selection_area" class="news-selection">
                        <button class="news-btn selected" data-news-type="주요뉴스" onclick="naverScrapingNews(1)">주요뉴스</button>
                        <button class="news-btn" data-news-type="시황,전망" onclick="naverScrapingNews(2)">시황,전망</button>
                        <button class="news-btn" data-news-type="기업,종목분석" onclick="naverScrapingNews(3)">기업,종목분석</button>
                        <button class="news-btn" data-news-type="채권,선물" onclick="naverScrapingNews(4)">채권,선물</button>
                        <button class="news-btn" data-news-type="공시,메모" onclick="naverScrapingNews(5)">공시,메모</button>
                        <button class="news-btn" data-news-type="환율" onclick="naverScrapingNews(6)">환율</button>
                        <button class="news-api-btn" data-news-type="네이버 검색" onclick="naverKeyword()">그냥 내가 검색</button>
                    </div>
                    <!-- AI 요약 버튼 추가 -->
                    <div class="ai-summary-button-container">
                        <button class="ai-summary-button">아래 기사들에 대한 AI 요약 및 의견 보기</button>
                    </div>
                    <div id="news_show_area" class="news-show"></div> 
                </div>                  
            </div>
            <!-- 우측 영역 끝 -->

        </main>

    </div>
    <!-- wrap 끝 -->
    <script>
        function guideTab(){
            $('.menu-list li').click(function(event){
                event.preventDefault(); // 기본 동작 방지
                var activeTab = $(this).attr('data-tab');
                window.location.hash = activeTab; // URL 해시를 변경

                // 여기서 추가적인 액션을 호출
                switch(activeTab) {
                    case 'menub':
                        fetchBondsData(); // 글로벌 주요경제지표 데이터 가져오기
                        break;
                    case 'menue':
                        goCalendar(); // 증시 캘린더 보여주기
                        break;
                    // 다른 탭에 대한 추가적인 액션을 여기에 추가할 수 있습니다.
                }
            });
        }

        function setActiveTab() {
            var activeTab = window.location.hash.replace('#', '');
            if(activeTab) {
                $('.menu-list li, .menu-cont').removeClass('on');
                $('[data-tab="' + activeTab + '"]').addClass('on');
                $('#' + activeTab).addClass('on');
            }
        }     
        $(document).ready(function() {
            // 메뉴 업데이트와 이벤트 바인딩을 처리하는 함수
            function updateAndBindMenu() {
                $('.menux ul li').click(function(event) {
                    event.preventDefault(); // 기본 동작 방지                    
                    var menuType = $(this).data('menu');
                    updateMenuList(menuType); // 메뉴 타입에 따라 메뉴 리스트 업데이트
                });
        
                // 메뉴 리스트 항목에 대한 클릭 이벤트 바인딩
                $('.menu-list').on('click', 'li', function(event) {
                    event.preventDefault(); // 기본 동작 방지
                    var activeTab = $(this).data('tab');
                    window.location.hash = activeTab; // URL 해시를 변경
        
                    // 여기서 추가적인 액션을 호출
                    executeTabAction(activeTab);
                });
        
                setActiveTab(); // 활성 탭 설정
                $(window).on('hashchange', setActiveTab); // 해시 변경에 따른 탭 설정
            }
            // 메뉴에 따른 추가적인 액션을 실행
            function executeTabAction(activeTab) {
                switch(activeTab) {
                    case 'menub':
                        fetchBondsData(); // 글로벌 주요경제지표 데이터 가져오기
                        break;
                    case 'menue':
                        goCalendar(); // 증시 캘린더 보여주기
                        break;
                    case 'menu_2nd_a':
                        naverScrapingNews(1); // 네이버 주요뉴스 스크래핑한거 보여주기
                        break;
                    case 'menu_2nd_b' :
                        similarSitu(); // 국내주식 유사국면 분석
                        break;
                }
            }      
            //GNB 넣으면서 메뉴구조 바꾸기!! 파일쪼개기는 시간상 버겁다 ㅠㅠ
            function updateMenuList(menuType) {
                $('.menu-list').empty(); // 기존 메뉴 리스트 비우기
             
                var menuItems = [];
                if(menuType === 'menu1') {
                    // 마켓데이터 해외 메뉴 리스트
                    var menuItems = [
                        '<li class="page-menu on" data-tab="menua"><a href="javascript:void(0);">1. AI가 말해주는 주식 정보 [해외]</a></li>',
                        '<li class="page-menu" data-tab="menub"><a href="javascript:void(0);">2. 글로벌 주요경제지표</a></li>',
                        '<li class="page-menu" data-tab="menuc"><a href="javascript:void(0);">3. 뉴스 데이터 분석 [해외]</a></li>',
                        '<li class="page-menu" data-tab="menud"><a href="javascript:void(0);">4. 마켓 PDF 분석</a></li>',
                        '<li class="page-menu" data-tab="menue"><a href="javascript:void(0);">5. 증시 캘린더</a></li>'
                    ];
                    $('.menu-list').append(menuItems.join(''));
                } else if(menuType === 'menu2') {
                    // 마켓데이터 국내 메뉴 리스트
                    var menuItems = [
                        '<li class="page-menu on" data-tab="menu_2nd_a"><a href="javascript:void(0);">1. 국내 뉴스 정보</a></li>',
                        '<li class="page-menu" data-tab="menu_2nd_b"><a href="javascript:void(0);">2. 유사국면 분석</a></li>'
                    ];
                    $('.menu-list').append(menuItems.join(''));
                } else if(menuType === 'menu3') {
                    // 마켓데이터 국내 메뉴 리스트
                    alert("준비중입니다");
                    return;
                }
                // GNB 클릭 시 첫 번째 하위 메뉴 활성화
               /** if(menuType === 'menu2') {
                    setTimeout(function() { // DOM 업데이트 후 활성화를 위해 setTimeout 사용
                        $('.menu-list li:first-child').click();
                    }, 5);
                } **/               
                updateAndBindMenu(); // 페이지 로딩 시 메뉴 업데이트와 이벤트 바인딩 실행
            }
        
            $('.menux ul li').click(function(event) {
                event.preventDefault(); // 기본 동작 방지
                var menuType = $(this).data('menu');
                updateMenuList(menuType); // 메뉴 타입에 따라 메뉴 리스트 업데이트
            });
        
            updateAndBindMenu(); // 초기 이벤트 바인딩
            setActiveTab(); // 활성 탭 설정
            $(window).on('hashchange', setActiveTab); // 해시 변경에 따른 탭 설정
        });
        
        /**** News 영역 Listener****/
        // 'All Market News' 체크박스를 클릭할 때 다른 체크박스를 체크 해제하자
        document.getElementById('all').addEventListener('click', function() {
            const allCheckbox = this;
            const otherCheckboxes = document.querySelectorAll("#categoryForm input[name='categories']:not(#all)");
            otherCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        });

        // 다른 체크박스를 클릭할 때 'All Market News' 체크박스는 해제하자. 
        document.querySelectorAll("#categoryForm input[name='categories']:not(#all)").forEach(checkbox => {
            checkbox.addEventListener('click', function() {
                if (this.checked) {
                    document.getElementById('all').checked = false; // 'All Market News' 체크박스를 해제합니다.
                }
            });
        });
        // 국내 뉴스 버튼 제어용 (selected 되게)
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('.news-btn');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    buttons.forEach(btn => btn.classList.remove('selected')); // 다른 버튼들에서 'selected' 클래스 제거
                    this.classList.add('selected'); // 현재 클릭된 버튼에 'selected' 클래스 추가
                });
            });
        });

  </script>
  </body>
   <!-- PDF.js 라이브러리 로드 -->
   <script type="module" src="/static/assets/js/pdf.mjs"></script>
   <script type="module" src="/static/assets/js/pdf.worker.mjs"></script>
   <script src="/static/assets/js/pdf-to-image.js"></script>
</html>